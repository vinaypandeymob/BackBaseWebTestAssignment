"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.server = server;
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _constants = require("../constants");

var _events = require("events");

const KEEP_ALIVE_TIMEOUT_MS = 60 * 10 * 1000;

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _constants.DEFAULT_BASE_PATH,
    plugins = []
  } = opts;
  const app = (0, _express.default)();

  const httpServer = _http.default.createServer(app);

  return await new _bluebird.default(async (resolve, reject) => {
    try {
      configureHttp({
        httpServer,
        reject
      });
      configureServer({
        app,
        addRoutes: routeConfiguringFunction,
        allowCors,
        basePath,
        plugins
      });
      await configureServerPlugins({
        app,
        httpServer,
        plugins
      });
      app.use(_middleware.catch404Handler);
      await startServer({
        httpServer,
        hostname,
        port
      });
      resolve(httpServer);
    } catch (err) {
      reject(err);
    }
  });
}

function configureServer({
  app,
  addRoutes,
  allowCors = true,
  basePath = _constants.DEFAULT_BASE_PATH,
  plugins = []
}) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use(_middleware.handleIdempotency);
  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catch4XXHandler);
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  const extraMethods = plugins.filter(p => {
    if (!_lodash.default.isPlainObject(p.newMethodMap)) {
      _logger.default.warn(`Tried to apply newMethodMap from plugin '${p.name}' but it was invalid. Will ` + `skip adding these methods to the method map.`);

      return false;
    }

    return true;
  }).map(p => p.newMethodMap);
  addRoutes(app, {
    basePath,
    extraMethods
  });
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
}

function configureHttp({
  httpServer,
  reject
}) {
  const serverState = {
    notifier: new _events.EventEmitter(),
    closed: false
  };
  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => await new _bluebird.default((resolve, reject) => {
    serverState.closed = true;
    serverState.notifier.emit('shutdown');

    _logger.default.info('Waiting until the server is closed');

    httpServer.on('close', () => {
      _logger.default.info('Received server close event');

      resolve();
    });
    close(err => {
      if (err) reject(err);
    });
  });

  httpServer.on('error', err => {
    if (err.code === 'EADDRNOTAVAIL') {
      _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
    } else {
      _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
    }

    reject(err);
  });
  httpServer.on('connection', socket => {
    socket.setTimeout(KEEP_ALIVE_TIMEOUT_MS);
    socket.on('error', reject);

    function destroy() {
      socket.destroy();
    }

    socket._openReqCount = 0;
    socket.once('close', () => serverState.notifier.removeListener('shutdown', destroy));
    serverState.notifier.once('shutdown', destroy);
  });
  httpServer.on('request', function (req, res) {
    const socket = req.connection || req.socket;
    socket._openReqCount++;
    res.on('finish', function () {
      socket._openReqCount--;

      if (serverState.closed && socket._openReqCount === 0) {
        socket.destroy();
      }
    });
  });
}

async function configureServerPlugins({
  plugins,
  app,
  httpServer
}) {
  for (const plugin of plugins.filter(p => p.updatesServer)) {
    _logger.default.info(`Allowing plugin ${plugin.name} to modify the Appium server`);

    try {
      await plugin.updateServer(app, httpServer);
    } catch (err) {
      _logger.default.error(`Plugin '${plugin.name}' tried to update the server but the updateServer ` + `method was not implemented, did not return a promise, or threw an ` + `error. Original message: ${err}.`);

      throw err;
    }
  }
}

async function startServer({
  httpServer,
  port,
  hostname
}) {
  const serverArgs = [port];

  if (hostname) {
    serverArgs.push(hostname);
  }

  const startPromise = _bluebird.default.promisify(httpServer.listen, {
    context: httpServer
  })(...serverArgs);

  httpServer.keepAliveTimeout = KEEP_ALIVE_TIMEOUT_MS;
  httpServer.headersTimeout = KEEP_ALIVE_TIMEOUT_MS + 5 * 1000;
  await startPromise;
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3NlcnZlci5qcyJdLCJuYW1lcyI6WyJLRUVQX0FMSVZFX1RJTUVPVVRfTVMiLCJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsInBsdWdpbnMiLCJhcHAiLCJodHRwU2VydmVyIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwiY29uZmlndXJlSHR0cCIsImNvbmZpZ3VyZVNlcnZlciIsImFkZFJvdXRlcyIsImNvbmZpZ3VyZVNlcnZlclBsdWdpbnMiLCJ1c2UiLCJjYXRjaDQwNEhhbmRsZXIiLCJzdGFydFNlcnZlciIsImVyciIsIm5vcm1hbGl6ZUJhc2VQYXRoIiwiZW5kTG9nRm9ybWF0dGVyIiwicGF0aCIsIlNUQVRJQ19ESVIiLCJleHByZXNzIiwic3RhdGljIiwicHJvZHVjZUVycm9yIiwicHJvZHVjZUNyYXNoIiwiYWxsb3dDcm9zc0RvbWFpbiIsImhhbmRsZUlkZW1wb3RlbmN5IiwiZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlIiwiYm9keVBhcnNlciIsInVybGVuY29kZWQiLCJleHRlbmRlZCIsImNhdGNoNFhYSGFuZGxlciIsImNhdGNoQWxsSGFuZGxlciIsImpzb24iLCJsaW1pdCIsInN0YXJ0TG9nRm9ybWF0dGVyIiwiZXh0cmFNZXRob2RzIiwiZmlsdGVyIiwicCIsIl8iLCJpc1BsYWluT2JqZWN0IiwibmV3TWV0aG9kTWFwIiwibG9nIiwid2FybiIsIm5hbWUiLCJtYXAiLCJhbGwiLCJ3ZWxjb21lIiwiZ3VpbmVhUGlnIiwiZ3VpbmVhUGlnU2Nyb2xsYWJsZSIsImd1aW5lYVBpZ0FwcEJhbm5lciIsInNlcnZlclN0YXRlIiwibm90aWZpZXIiLCJFdmVudEVtaXR0ZXIiLCJjbG9zZWQiLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsInJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJjbG9zZSIsImJpbmQiLCJlbWl0IiwiaW5mbyIsIm9uIiwiY29kZSIsImVycm9yIiwic29ja2V0Iiwic2V0VGltZW91dCIsImRlc3Ryb3kiLCJfb3BlblJlcUNvdW50Iiwib25jZSIsInJlbW92ZUxpc3RlbmVyIiwicmVxIiwicmVzIiwiY29ubmVjdGlvbiIsInBsdWdpbiIsInVwZGF0ZXNTZXJ2ZXIiLCJ1cGRhdGVTZXJ2ZXIiLCJzZXJ2ZXJBcmdzIiwicHVzaCIsInN0YXJ0UHJvbWlzZSIsInByb21pc2lmeSIsImxpc3RlbiIsImNvbnRleHQiLCJrZWVwQWxpdmVUaW1lb3V0IiwiaGVhZGVyc1RpbWVvdXQiLCJpc1N0cmluZyIsIkVycm9yIiwicmVwbGFjZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUtBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLHFCQUFxQixHQUFHLEtBQUssRUFBTCxHQUFVLElBQXhDOztBQUdBLGVBQWVDLE1BQWYsQ0FBdUJDLElBQUksR0FBRyxFQUE5QixFQUFrQztBQUNoQyxRQUFNO0FBQ0pDLElBQUFBLHdCQURJO0FBRUpDLElBQUFBLElBRkk7QUFHSkMsSUFBQUEsUUFBUSxHQUFHLElBSFA7QUFJSkMsSUFBQUEsU0FBUyxHQUFHLElBSlI7QUFLSkMsSUFBQUEsUUFBUSxHQUFHQyw0QkFMUDtBQU1KQyxJQUFBQSxPQUFPLEdBQUc7QUFOTixNQU9GUCxJQVBKO0FBVUEsUUFBTVEsR0FBRyxHQUFHLHVCQUFaOztBQUNBLFFBQU1DLFVBQVUsR0FBR0MsY0FBS0MsWUFBTCxDQUFrQkgsR0FBbEIsQ0FBbkI7O0FBQ0EsU0FBTyxNQUFNLElBQUlJLGlCQUFKLENBQU0sT0FBT0MsT0FBUCxFQUFnQkMsTUFBaEIsS0FB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QUFRLENBQUMsQ0FBRCxDQUFSLEtBQWdCLEdBQXZDLEVBQTRDO0FBQzFDQSxJQUFBQSxRQUFRLEdBQUksSUFBR0EsUUFBUyxFQUF4QjtBQUNEOztBQUVELFNBQU9BLFFBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgZmF2aWNvbiBmcm9tICdzZXJ2ZS1mYXZpY29uJztcbmltcG9ydCBib2R5UGFyc2VyIGZyb20gJ2JvZHktcGFyc2VyJztcbmltcG9ydCBtZXRob2RPdmVycmlkZSBmcm9tICdtZXRob2Qtb3ZlcnJpZGUnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBzdGFydExvZ0Zvcm1hdHRlciwgZW5kTG9nRm9ybWF0dGVyIH0gZnJvbSAnLi9leHByZXNzLWxvZ2dpbmcnO1xuaW1wb3J0IHtcbiAgYWxsb3dDcm9zc0RvbWFpbiwgZml4UHl0aG9uQ29udGVudFR5cGUsIGRlZmF1bHRUb0pTT05Db250ZW50VHlwZSxcbiAgY2F0Y2hBbGxIYW5kbGVyLCBjYXRjaDQwNEhhbmRsZXIsIGNhdGNoNFhYSGFuZGxlcixcbiAgYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZSwgaGFuZGxlSWRlbXBvdGVuY3ksXG59IGZyb20gJy4vbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBndWluZWFQaWcsIGd1aW5lYVBpZ1Njcm9sbGFibGUsIGd1aW5lYVBpZ0FwcEJhbm5lciwgd2VsY29tZSwgU1RBVElDX0RJUiB9IGZyb20gJy4vc3RhdGljJztcbmltcG9ydCB7IHByb2R1Y2VFcnJvciwgcHJvZHVjZUNyYXNoIH0gZnJvbSAnLi9jcmFzaCc7XG5pbXBvcnQge1xuICBhZGRXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyxcbiAgZ2V0V2ViU29ja2V0SGFuZGxlcnNcbn0gZnJvbSAnLi93ZWJzb2NrZXQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgREVGQVVMVF9CQVNFX1BBVEggfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuXG5jb25zdCBLRUVQX0FMSVZFX1RJTUVPVVRfTVMgPSA2MCAqIDEwICogMTAwMDsgLy8gMTAgbWludXRlc1xuXG5cbmFzeW5jIGZ1bmN0aW9uIHNlcnZlciAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sXG4gICAgcG9ydCxcbiAgICBob3N0bmFtZSA9IG51bGwsXG4gICAgYWxsb3dDb3JzID0gdHJ1ZSxcbiAgICBiYXNlUGF0aCA9IERFRkFVTFRfQkFTRV9QQVRILFxuICAgIHBsdWdpbnMgPSBbXVxuICB9ID0gb3B0cztcblxuICAvLyBjcmVhdGUgdGhlIGFjdHVhbCBodHRwIHNlcnZlclxuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGNvbnN0IGh0dHBTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIHdlIHB1dCBhbiBhc3luYyBmdW5jdGlvbiBhcyB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvciBiZWNhdXNlIHdlIHdhbnQgc29tZSB0aGluZ3MgdG8gaGFwcGVuIGluXG4gICAgLy8gc2VyaWFsIChhcHBsaWNhdGlvbiBvZiBwbHVnaW4gdXBkYXRlcywgZm9yIGV4YW1wbGUpLiBCdXQgd2Ugc3RpbGwgbmVlZCB0byB1c2UgYSBwcm9taXNlIGhlcmVcbiAgICAvLyBiZWNhdXNlIHNvbWUgZWxlbWVudHMgb2Ygc2VydmVyIHN0YXJ0IGZhaWx1cmUgb25seSBoYXBwZW4gaW4gaHR0cFNlcnZlciBsaXN0ZW5lcnMuIFNvIHRoZVxuICAgIC8vIHdheSB3ZSByZXNvbHZlIGl0IGlzIHRvIHVzZSBhbiBhc3luYyBmdW5jdGlvbiBoZXJlIGJ1dCB0byB3cmFwIGFsbCB0aGUgaW5uZXIgbG9naWMgaW5cbiAgICAvLyB0cnkvY2F0Y2ggc28gYW55IGVycm9ycyBjYW4gYmUgcGFzc2VkIHRvIHJlamVjdC5cbiAgICB0cnkge1xuICAgICAgY29uZmlndXJlSHR0cCh7aHR0cFNlcnZlciwgcmVqZWN0fSk7XG4gICAgICBjb25maWd1cmVTZXJ2ZXIoe2FwcCwgYWRkUm91dGVzOiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIGFsbG93Q29ycywgYmFzZVBhdGgsIHBsdWdpbnN9KTtcbiAgICAgIGF3YWl0IGNvbmZpZ3VyZVNlcnZlclBsdWdpbnMoe2FwcCwgaHR0cFNlcnZlciwgcGx1Z2luc30pO1xuXG4gICAgICAvLyBjYXRjaCB0aGlzIGxhc3QsIGFmdGVyIHBsdWdpbnMgaGF2ZSBoYWQgYSBjaGFuY2UgdG8gbW9kaWZ5IGFwcCwgc28gYW55dGhpbmcgdGhhdCBmYWxsc1xuICAgICAgLy8gdGhyb3VnaCBpcyA0MDRlZFxuICAgICAgYXBwLnVzZShjYXRjaDQwNEhhbmRsZXIpO1xuICAgICAgYXdhaXQgc3RhcnRTZXJ2ZXIoe2h0dHBTZXJ2ZXIsIGhvc3RuYW1lLCBwb3J0fSk7XG4gICAgICByZXNvbHZlKGh0dHBTZXJ2ZXIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmVqZWN0KGVycik7XG4gICAgfVxuICB9KTtcblxufVxuXG5mdW5jdGlvbiBjb25maWd1cmVTZXJ2ZXIgKHtcbiAgYXBwLFxuICBhZGRSb3V0ZXMsXG4gIGFsbG93Q29ycyA9IHRydWUsXG4gIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgsXG4gIHBsdWdpbnMgPSBbXSxcbn0pIHtcbiAgYmFzZVBhdGggPSBub3JtYWxpemVCYXNlUGF0aChiYXNlUGF0aCk7XG5cbiAgYXBwLnVzZShlbmRMb2dGb3JtYXR0ZXIpO1xuXG4gIC8vIHNldCB1cCBzdGF0aWMgYXNzZXRzXG4gIGFwcC51c2UoZmF2aWNvbihwYXRoLnJlc29sdmUoU1RBVElDX0RJUiwgJ2Zhdmljb24uaWNvJykpKTtcbiAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhTVEFUSUNfRElSKSk7XG5cbiAgLy8gY3Jhc2ggcm91dGVzLCBmb3IgdGVzdGluZ1xuICBhcHAudXNlKGAke2Jhc2VQYXRofS9wcm9kdWNlX2Vycm9yYCwgcHJvZHVjZUVycm9yKTtcbiAgYXBwLnVzZShgJHtiYXNlUGF0aH0vY3Jhc2hgLCBwcm9kdWNlQ3Jhc2gpO1xuXG4gIC8vIGFkZCBtaWRkbGV3YXJlc1xuICBpZiAoYWxsb3dDb3JzKSB7XG4gICAgYXBwLnVzZShhbGxvd0Nyb3NzRG9tYWluKTtcbiAgfSBlbHNlIHtcbiAgICBhcHAudXNlKGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUoYmFzZVBhdGgpKTtcbiAgfVxuICBhcHAudXNlKGhhbmRsZUlkZW1wb3RlbmN5KTtcbiAgYXBwLnVzZShmaXhQeXRob25Db250ZW50VHlwZShiYXNlUGF0aCkpO1xuICBhcHAudXNlKGRlZmF1bHRUb0pTT05Db250ZW50VHlwZSk7XG4gIGFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZX0pKTtcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZSgpKTtcbiAgYXBwLnVzZShjYXRjaDRYWEhhbmRsZXIpO1xuICBhcHAudXNlKGNhdGNoQWxsSGFuZGxlcik7XG5cbiAgLy8gbWFrZSBzdXJlIGFwcGl1bSBuZXZlciBmYWlscyBiZWNhdXNlIG9mIGEgZmlsZSBzaXplIHVwbG9hZCBsaW1pdFxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7bGltaXQ6ICcxZ2InfSkpO1xuXG4gIC8vIHNldCB1cCBzdGFydCBsb2dnaW5nICh3aGljaCBkZXBlbmRzIG9uIGJvZHlQYXJzZXIgZG9pbmcgaXRzIHRoaW5nKVxuICBhcHAudXNlKHN0YXJ0TG9nRm9ybWF0dGVyKTtcblxuICBjb25zdCBleHRyYU1ldGhvZHMgPSBwbHVnaW5zLmZpbHRlcigocCkgPT4ge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHAubmV3TWV0aG9kTWFwKSkge1xuICAgICAgbG9nLndhcm4oYFRyaWVkIHRvIGFwcGx5IG5ld01ldGhvZE1hcCBmcm9tIHBsdWdpbiAnJHtwLm5hbWV9JyBidXQgaXQgd2FzIGludmFsaWQuIFdpbGwgYCArXG4gICAgICAgICAgICAgICBgc2tpcCBhZGRpbmcgdGhlc2UgbWV0aG9kcyB0byB0aGUgbWV0aG9kIG1hcC5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0pLm1hcCgocCkgPT4gcC5uZXdNZXRob2RNYXApO1xuICBhZGRSb3V0ZXMoYXBwLCB7YmFzZVBhdGgsIGV4dHJhTWV0aG9kc30pO1xuXG4gIC8vIGR5bmFtaWMgcm91dGVzIGZvciB0ZXN0aW5nLCBldGMuXG4gIGFwcC5hbGwoJy93ZWxjb21lJywgd2VsY29tZSk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWcnLCBndWluZWFQaWcpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnLXNjcm9sbGFibGUnLCBndWluZWFQaWdTY3JvbGxhYmxlKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZy1hcHAtYmFubmVyJywgZ3VpbmVhUGlnQXBwQmFubmVyKTtcbn1cblxuZnVuY3Rpb24gY29uZmlndXJlSHR0cCAoe2h0dHBTZXJ2ZXIsIHJlamVjdH0pIHtcbiAgY29uc3Qgc2VydmVyU3RhdGUgPSB7XG4gICAgbm90aWZpZXI6IG5ldyBFdmVudEVtaXR0ZXIoKSxcbiAgICBjbG9zZWQ6IGZhbHNlLFxuICB9O1xuICBodHRwU2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIgPSBhZGRXZWJTb2NrZXRIYW5kbGVyO1xuICBodHRwU2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIgPSByZW1vdmVXZWJTb2NrZXRIYW5kbGVyO1xuICBodHRwU2VydmVyLnJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzID0gcmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnM7XG4gIGh0dHBTZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMgPSBnZXRXZWJTb2NrZXRIYW5kbGVycztcblxuICAvLyBodHRwLlNlcnZlci5jbG9zZSgpIG9ubHkgc3RvcHMgbmV3IGNvbm5lY3Rpb25zLCBidXQgd2UgbmVlZCB0byB3YWl0IHVudGlsXG4gIC8vIGFsbCBjb25uZWN0aW9ucyBhcmUgY2xvc2VkIGFuZCB0aGUgYGNsb3NlYCBldmVudCBpcyBlbWl0dGVkXG4gIGNvbnN0IGNsb3NlID0gaHR0cFNlcnZlci5jbG9zZS5iaW5kKGh0dHBTZXJ2ZXIpO1xuICBodHRwU2VydmVyLmNsb3NlID0gYXN5bmMgKCkgPT4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS12MC54LWFyY2hpdmUvaXNzdWVzLzkwNjYjaXNzdWVjb21tZW50LTEyNDIxMDU3NlxuICAgIHNlcnZlclN0YXRlLmNsb3NlZCA9IHRydWU7XG4gICAgc2VydmVyU3RhdGUubm90aWZpZXIuZW1pdCgnc2h1dGRvd24nKTtcbiAgICBsb2cuaW5mbygnV2FpdGluZyB1bnRpbCB0aGUgc2VydmVyIGlzIGNsb3NlZCcpO1xuICAgIGh0dHBTZXJ2ZXIub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgbG9nLmluZm8oJ1JlY2VpdmVkIHNlcnZlciBjbG9zZSBldmVudCcpO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICAgIGNsb3NlKChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgfSk7XG4gIH0pO1xuXG4gIGh0dHBTZXJ2ZXIub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBRERSTk9UQVZBSUwnKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NvdWxkIG5vdCBzdGFydCBSRVNUIGh0dHAgaW50ZXJmYWNlIGxpc3RlbmVyLiAnICtcbiAgICAgICAgICAgICAgICAnUmVxdWVzdGVkIGFkZHJlc3MgaXMgbm90IGF2YWlsYWJsZS4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmVycm9yKCdDb3VsZCBub3Qgc3RhcnQgUkVTVCBodHRwIGludGVyZmFjZSBsaXN0ZW5lci4gVGhlIHJlcXVlc3RlZCAnICtcbiAgICAgICAgICAgICAgICAncG9ydCBtYXkgYWxyZWFkeSBiZSBpbiB1c2UuIFBsZWFzZSBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gJyArXG4gICAgICAgICAgICAgICAgJ290aGVyIGluc3RhbmNlIG9mIHRoaXMgc2VydmVyIHJ1bm5pbmcgYWxyZWFkeS4nKTtcbiAgICB9XG4gICAgcmVqZWN0KGVycik7XG4gIH0pO1xuXG4gIGh0dHBTZXJ2ZXIub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0KSA9PiB7XG4gICAgc29ja2V0LnNldFRpbWVvdXQoS0VFUF9BTElWRV9USU1FT1VUX01TKTtcbiAgICBzb2NrZXQub24oJ2Vycm9yJywgcmVqZWN0KTtcblxuICAgIGZ1bmN0aW9uIGRlc3Ryb3kgKCkge1xuICAgICAgc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgc29ja2V0Ll9vcGVuUmVxQ291bnQgPSAwO1xuICAgIHNvY2tldC5vbmNlKCdjbG9zZScsICgpID0+IHNlcnZlclN0YXRlLm5vdGlmaWVyLnJlbW92ZUxpc3RlbmVyKCdzaHV0ZG93bicsIGRlc3Ryb3kpKTtcbiAgICBzZXJ2ZXJTdGF0ZS5ub3RpZmllci5vbmNlKCdzaHV0ZG93bicsIGRlc3Ryb3kpO1xuICB9KTtcblxuICBodHRwU2VydmVyLm9uKCdyZXF1ZXN0JywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgY29uc3Qgc29ja2V0ID0gcmVxLmNvbm5lY3Rpb24gfHwgcmVxLnNvY2tldDtcbiAgICBzb2NrZXQuX29wZW5SZXFDb3VudCsrO1xuICAgIHJlcy5vbignZmluaXNoJywgZnVuY3Rpb24gKCkge1xuICAgICAgc29ja2V0Ll9vcGVuUmVxQ291bnQtLTtcbiAgICAgIGlmIChzZXJ2ZXJTdGF0ZS5jbG9zZWQgJiYgc29ja2V0Ll9vcGVuUmVxQ291bnQgPT09IDApIHtcbiAgICAgICAgc29ja2V0LmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmZpZ3VyZVNlcnZlclBsdWdpbnMgKHtwbHVnaW5zLCBhcHAsIGh0dHBTZXJ2ZXJ9KSB7XG4gIC8vIGFsbG93IHBsdWdpbnMgdG8gdXBkYXRlIHRoZSBhcHAgYW5kIGh0dHAgc2VydmVyIG9iamVjdHNcbiAgZm9yIChjb25zdCBwbHVnaW4gb2YgcGx1Z2lucy5maWx0ZXIoKHApID0+IHAudXBkYXRlc1NlcnZlcikpIHtcbiAgICBsb2cuaW5mbyhgQWxsb3dpbmcgcGx1Z2luICR7cGx1Z2luLm5hbWV9IHRvIG1vZGlmeSB0aGUgQXBwaXVtIHNlcnZlcmApO1xuICAgIHRyeSB7XG4gICAgICAvLyB3cmFwIHRoaXMgaW4gZXJyb3IgaGFuZGxpbmcgaW4gY2FzZSB0aGUgcGx1Z2luIGZvcmdvdCB0byBtYXJrIHRoZSBmdW5jdGlvbiBhc3luYyBvclxuICAgICAgLy8gZm9yZ290IHRvIGltcGxlbWVudCBpdFxuICAgICAgYXdhaXQgcGx1Z2luLnVwZGF0ZVNlcnZlcihhcHAsIGh0dHBTZXJ2ZXIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yKGBQbHVnaW4gJyR7cGx1Z2luLm5hbWV9JyB0cmllZCB0byB1cGRhdGUgdGhlIHNlcnZlciBidXQgdGhlIHVwZGF0ZVNlcnZlciBgICtcbiAgICAgICAgICAgICAgICBgbWV0aG9kIHdhcyBub3QgaW1wbGVtZW50ZWQsIGRpZCBub3QgcmV0dXJuIGEgcHJvbWlzZSwgb3IgdGhyZXcgYW4gYCArXG4gICAgICAgICAgICAgICAgYGVycm9yLiBPcmlnaW5hbCBtZXNzYWdlOiAke2Vycn0uYCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyICh7aHR0cFNlcnZlciwgcG9ydCwgaG9zdG5hbWV9KSB7XG4gIGNvbnN0IHNlcnZlckFyZ3MgPSBbcG9ydF07XG4gIGlmIChob3N0bmFtZSkge1xuICAgIC8vIElmIHRoZSBob3N0bmFtZSBpcyBvbWl0dGVkLCB0aGUgc2VydmVyIHdpbGwgYWNjZXB0XG4gICAgLy8gY29ubmVjdGlvbnMgb24gYW55IElQIGFkZHJlc3NcbiAgICBzZXJ2ZXJBcmdzLnB1c2goaG9zdG5hbWUpO1xuICB9XG4gIGNvbnN0IHN0YXJ0UHJvbWlzZSA9IEIucHJvbWlzaWZ5KGh0dHBTZXJ2ZXIubGlzdGVuLCB7Y29udGV4dDogaHR0cFNlcnZlcn0pKC4uLnNlcnZlckFyZ3MpO1xuICBodHRwU2VydmVyLmtlZXBBbGl2ZVRpbWVvdXQgPSBLRUVQX0FMSVZFX1RJTUVPVVRfTVM7XG4gIC8vIGhlYWRlcnMgdGltZW91dCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBrZWVwQWxpdmVUaW1lb3V0XG4gIGh0dHBTZXJ2ZXIuaGVhZGVyc1RpbWVvdXQgPSBLRUVQX0FMSVZFX1RJTUVPVVRfTVMgKyA1ICogMTAwMDtcbiAgYXdhaXQgc3RhcnRQcm9taXNlO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVCYXNlUGF0aCAoYmFzZVBhdGgpIHtcbiAgaWYgKCFfLmlzU3RyaW5nKGJhc2VQYXRoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYXRoIHByZWZpeCAke2Jhc2VQYXRofWApO1xuICB9XG5cbiAgLy8gZW5zdXJlIHRoZSBwYXRoIHByZWZpeCBkb2VzIG5vdCBlbmQgaW4gJy8nLCBzaW5jZSBvdXIgbWV0aG9kIG1hcFxuICAvLyBzdGFydHMgYWxsIHBhdGhzIHdpdGggJy8nXG4gIGJhc2VQYXRoID0gYmFzZVBhdGgucmVwbGFjZSgvXFwvJC8sICcnKTtcblxuICAvLyBsaWtld2lzZSwgZW5zdXJlIHRoZSBwYXRoIHByZWZpeCBkb2VzIGFsd2F5cyBTVEFSVCB3aXRoIC8sIHVubGVzcyB0aGUgcGF0aFxuICAvLyBpcyBlbXB0eSBtZWFuaW5nIG5vIGJhc2UgcGF0aCBhdCBhbGxcbiAgaWYgKGJhc2VQYXRoICE9PSAnJyAmJiBiYXNlUGF0aFswXSAhPT0gJy8nKSB7XG4gICAgYmFzZVBhdGggPSBgLyR7YmFzZVBhdGh9YDtcbiAgfVxuXG4gIHJldHVybiBiYXNlUGF0aDtcbn1cblxuZXhwb3J0IHsgc2VydmVyLCBjb25maWd1cmVTZXJ2ZXIsIG5vcm1hbGl6ZUJhc2VQYXRoIH07XG4iXSwiZmlsZSI6ImxpYi9leHByZXNzL3NlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
